---
title: "E-commerceDB"
author: "Group-8"
date: "2024-02-27"
output: 
  pdf_document:
  extra_dependencies: ["bbm", "threeparttable"]
editor_options: 
  chunk_output_type: inline
---

# Load necessary libraries

```{r}

library(knitr)
library(kableExtra)
library(readr)
library(RSQLite)
library(dplyr)
library(stringr)
```

```{r}

con <- dbConnect(RSQLite::SQLite(), "ecommerce.db")

sql_file <- readLines("dbScript.sql")

for (sql_command in sql_file) {
   if (sql_command!=""){
    print(sql_command)
    dbExecute(con, sql_command)
    print("-------------DONE---------")
   }
}


```


```{r}

Customers <- read_csv("Files/Customers.csv")


Products <- read_csv("Files/Products.csv")


Order_details <- read_csv("Files/Order_Details.csv",
    skip = 1)

Reviews <- read_csv("Files/Reviews.csv",
    skip = 1)

Suppliers <- read_csv("Files/Suppliers.csv")


Product_Discounts <- read_csv("Files/Product_Discounts.csv")


Product_Category <- read_csv("Files/Product_Category.csv")


Order_Item <- read_csv("Files/Order_Item.csv", 
    skip = 1)

```

```{r}
# To create empty column for the Products table 
Products <- Products %>%
  mutate(Category_ID = NA)

# To apply the foreign key into the table 
# Define a function to assign Category_ID based on keywords in Product_Name
assign_category_id <- function(Product_Name) {
  if (grepl("TV|Television", Product_Name, ignore.case = TRUE)) {
    return("CAT1")
  } else if (grepl("Laptop|Tablet|Computing|Book|Surface|Monitor", Product_Name, ignore.case = TRUE)) {
    return("CAT2")
  } else if (grepl("Phone|Galaxy|Mi|P Series|OnePlus", Product_Name, ignore.case = TRUE)) {
    return("CAT3")
  } else if (grepl("Refrigerator|Washing Machine|Home Appliance|Microwave|Vacuum|Dishwasher", Product_Name, ignore.case = TRUE)){
    return("CAT4")
  } else if (grepl("Headphones|Speakers|Sound System|Earbuds|Speaker|Technica|Soundbar", Product_Name, ignore.case = TRUE)) {
    return("CAT5")
  } else if (grepl("Camera|Photography|GoPro|Mirrorless|Nikon|Camcorder|Compact", Product_Name, ignore.case = TRUE)) {
    return("CAT6")
  } else if (grepl("Xbox|PS|Gaming|Switch", Product_Name, ignore.case = TRUE)) {
    return("CAT7")
  } else if (grepl("Smart Home|Echo|Smart Lock|Steam Deck|Hue Light", Product_Name, ignore.case = TRUE)) {
    return("CAT8")
  } else if (grepl("Watch|Wearable|Quest|Tracker|Gear|Band|Glasses", Product_Name, ignore.case = TRUE)) {
    return("CAT9")
  } else if (grepl("Keyboard|Mouse|Peripheral|Thermostat", Product_Name, ignore.case = TRUE)) {
    return("CAT10")
  } else {
    return(NA) # For products that do not match any category
  }
}

# Apply the function to assign Category_ID to each product
Products$Category_ID <- sapply(Products$Product_Name, assign_category_id)
```

```{r}
# This is to add suppliers_id in Products
set.seed(123)

Products <- Products %>%
  mutate(Supplier_ID = NA)

# Create a function to find matching supplier ID or assign randomly if no match is found
assign_supplier_id <- function(Product_Name, Suppliers) {
  for (i in 1:nrow(Suppliers)) {
    if (str_detect(Product_Name, regex(Suppliers$Supplier_Name[i], ignore_case = TRUE))) {
      return(Suppliers$Supplier_ID[i])
    }
  }
  # If no match found, assign a random supplier ID
  random_supplier_id <- sample(Suppliers$Supplier_ID, 1)
  return(random_supplier_id)
}

Products$Supplier_ID <- sapply(Products$Product_Name, function(x) assign_supplier_id(x, Suppliers))

# Adding Discount_Code column into Products 
set.seed(123) # This is to ensure reproducibility

Products <- Products %>%
  mutate(Discount_Code = NA)

codes_to_assign <- sample(1:nrow(Products), 50)

random_discounts <- sample(Product_Discounts$Discount_Code, 50)

Products$Discount_Code[codes_to_assign] <- random_discounts
```

```{r}
# Product_ID column for reviews table 
set.seed(123)
Reviews <- Reviews %>% 
  mutate(Product_ID = sample(Products$Product_ID, nrow(Reviews), replace = TRUE))
```

```{r}
# Adding Cust_ID column for Order_details table. 
set.seed(123)
Order_details <- Order_details %>%
  mutate(Cust_ID = sample(Customers$Cust_ID, nrow(Order_details), replace = TRUE))
```

```{r}
# Filter out the rows from Products that have a Disocunt_Code assigned 
discounted_products <- Products %>%
  filter(!is.na(Discount_Code)) %>%
  select(Product_ID, Discount_Code)

# Do a left join to join it together 
Product_Discounts <- Product_Discounts %>%
  left_join(discounted_products, by = "Discount_Code")

# Same step for cat_id
# Filter out the rows from Products that have a discount code assigned on the cat ID
discounted_cat <- Products %>%
  filter(!is.na(Category_ID)) %>%
  select(Category_ID, Discount_Code)

# Do a left join to join it together, thus we get to see which discount code assign to which category of goods
Product_Discounts <- Product_Discounts %>%
  left_join(discounted_cat, by = "Discount_Code")
```

```{r}
# Order_Items, product_ID
# Randomly assign a product ID, and order id (Order ID can repeat for at least 30 rows)
set.seed(123)
Order_Item <- Order_Item %>% 
  mutate(Product_ID = sample(Products$Product_ID, nrow(Order_Item), replace = TRUE))

# Use 70% of unique Order_IDs
subset_product_ids <- sample(unique(Products$Product_ID), size = floor(0.7 * length(unique(Products$Product_ID))))

# Sample from this subset with replacement to fill Order_Item$Order_ID, so there will be some repetitive.
Order_Item$Product_ID <- sample(subset_product_ids, nrow(Order_Item), replace = TRUE)

# Joining Order_Item with Products to get the Price for each Product_ID
Order_Item <- merge(Order_Item, Products[, c("Product_ID", "Product_Price")], by = "Product_ID", all.x = TRUE)

# Calculating Sum_Price as Price * Quantity
Order_Item <- Order_Item %>%
  mutate(Sum_Price = Product_Price * Quantity)

# Remove the Product_Price column 
Order_Item$Product_Price <- NULL
```

```{r}
Order_Item <- Order_Item %>%
  mutate(Product_ID = sample(subset_product_ids, nrow(Order_Item), replace = TRUE))

# Prepare a subset of Order_IDs to use
subset_order_ids <- sample(unique(Order_details$Order_ID), size = floor(0.7 * length(unique(Order_details$Order_ID))))

# Initialize Order_ID in Order_Item as NA
Order_Item$Order_ID <- NA

# Function to assign unique Order_IDs avoiding duplicates for each Product_ID
assign_unique_order_ids <- function(order_item, subset_order_ids) {
  for (i in 1:nrow(order_item)) {
    product_id <- order_item$Product_ID[i]
    # Available Order_IDs not yet used with this Product_ID
    available_order_ids <- setdiff(subset_order_ids, order_item$Order_ID[order_item$Product_ID == product_id])
    
    if (length(available_order_ids) == 0) {
      stop("Ran out of unique Order_IDs to assign for Product_ID: ", product_id)
    }
    
    # Randomly select an available Order_ID for the Product_ID
    order_item$Order_ID[i] <- sample(available_order_ids, 1)
  }
  
  order_item
}

# Apply the function to assign Order_IDs ensuring no Product_ID has duplicate Order_ID
Order_Item <- assign_unique_order_ids(Order_Item, subset_order_ids)

```
# Part 1: Database Design and Implementation

## 1.1 Entity Relationship Diagram

-   Here Insert ERD \*

The E-R diagram above simulates a real-world e-commerce data ecosystem, capturing the detailed relationships between entities and attributes essential for facilitating online transactions. In addition, it provides a comprehensive view of the e-commerce system, which serves as a platform for users to browse products, make purchases, and securely complete their payments.

### 1.1.1.Assumptions

-   The company only distributes products within the United Kingdom (UK).

-   The Currency used is Pound Sterling (GBP).

-   Attributes formats will be aligned with UK standard formats such as date , addresses , names ...etc

### 1.1.2. Entities and Attributes

This section describes and illustrates the entities and their respective attributes of the ER diagram above.

-   1.1.2.1. Customer shows us the users who previously have at least once purchased products and placed an order.

-   1.1.2.2. Supplier Vendors who provide products. Represent the source of the product items. 

-   1.1.2.3 Product Information about the model and price of the products as well as the availability of it. 

-   1.1.2.4 Order_details Contain information of orders including billing and shipping address, order and payment status, as well as order date and payment type. 

-   1.1.2.5 Product_Category Category of products offered by the e-commerce website. 

-   1.1.2.6 Product_Discounts Discount code that could be applied and the amount of discount it offers as well as the status of the discount. 

-   1.1.2.7 Reviews contain information of the reviews including text and rating on product and the likes of the top reviews as well as the time stamp of when the review was made. 

# Design Considerations

-   Absence of an Order Entity:

-   The model intentionally skips direct order management. Instead, it focuses on product management and customer interactions through reviews and payment methods.Additionally, This consideration will guarantee that products purchased by customers are not tracked or stored by the system to align with privacy policies.

-   Order Entity not considered in this ER design in order to follow best practices by not having to include orderId as part of product table which might affect the overall performance of DB retrieval.

-   Customer Engagement: By including Reviews, the model emphasizes customer engagement and feedback without directly managing transactions.

-   Payment Information: Including Payment_Method without an Order entity suggests a pre-registration of payment preferences or a simplified wallet storage that could be expanded in the future.

## Logical Schema

Customers ($\underline{Customer_id}$, Customer_Email, Cust_F_Name, Cust_L_Name, Phone_Country_Code, Phone_Num, Cust_Street_Name, Cust_Building_Name, Cust_Zip_Code)

Products ($\underline{Product_id}$, *Discount_Code*, *Category_id*, Product_Name, Product_Price, Product_Availability)

Suppliers ($\underline{Supplier_id}$, Supplier_Email, Supplier_Name, Supplier_Status, Sup_Building_Name, Sup_Street_Name, Sup_Zip_Code)

<!-- Order_Details ($\underline{Order_id}$, ${\textit{Customer_id}}$, Order_Date, Order_Total, Order_Status, S_Building_Name, S_Street_Name, S_Zip_Code, Street_Name, B_Building_Name, B_Street_Name, B_Zip_Code, Payment_Type, Payment_Status) -->

<!-- Discounts ($\underline{Discount_Code}$, Discount_Status, Discount_Amount) -->

<!-- Reviews ($\underline{Review_id}$, ${\textit{Product_id}}$, Review_Rating, Review_Timestamp, Review_Text, Review_Likes) -->

<!-- Categories ($\underline{Category_id}$, Category_Name) -->

<!-- Order_Items (${\textit{Order_id}}$, ${\textit{Customer_id}}$, ${\textit{Product_id}}$, Quantity, Unit_Price) -->

<!-- Supplied_Items ($\textit{Supplier_id}$, ${\textit{Product_id}}$, Supply_Contracts, Delivery_Terms, Pricing_Agreements) -->

<!-- Many to Many relation Table of Supplier and Product SupplierProduct ($\underline{Supplier_id,Product_id}$) -->

<!-- Many to Many relation Table of Order_details and Product ProductOrder_details ($\underline{Order_id, Product_id}$) -->
